\chapter{Diseño e implementación}
\label{Chapter3}

En este capítulo se presenta el diseño e implementación del sistema de
optimización biomecánica desarrollado en este trabajo. Se describe la
metodología empleada para estructurar el trabajo, la arquitectura del sistema
propuesto y los módulos que lo componen. La exposición se organiza de manera
secuencial, desde la adquisición de datos hasta la generación del reporte final
de recomendaciones.

%----------------------------------------------------------------------------------------
%	METODOLOGÍA
%----------------------------------------------------------------------------------------
\section{Metodología}
\label{sec:metodologia}

% Tono: Pasado (describe lo que SE HIZO en el trabajo).
Para la gestión y ejecución de este trabajo, se adaptó la metodología CRISP-DM
\citep{IBM_SPSS_CRISP_DM} (\textit{Cross-Industry Standard Process for Data
  Mining}). Esta adaptación fue necesaria para alinear las fases estándar de un
trabajo de minería de datos con los objetivos específicos del trabajo de
optimización biomecánica asistida por inteligencia artificial, como se describe
en la sección 8 del documento de planificación \citep{RGv5Goni}.

% Tono: Pasado (el trabajo de adaptación).
El modelo se reestructuró en las siguientes fases principales, que fueron
ajustadas al contexto del trabajo:

\begin{itemize}
  \item Comprensión del negocio y del problema biomecánico.
  \item Comprensión y adquisición de los datos (video, sensores de rendimiento y datos
        antropométricos).
  \item Preparación y preprocesamiento de los datos, lo que incluyó la extracción de pose
        y el filtrado de señales.
  \item Modelado y simulación biomecánica y aerodinámica.
  \item Evaluación de las soluciones generadas por el optimizador (análisis del frente
        de Pareto).
  \item Despliegue, el cual fue materializado en la generación del reporte de
        recomendaciones para el ciclista.
\end{itemize}

La figura \ref{fig:crisp_dm_flujo} muestra el diagrama de flujo de la
metodología implementada.

\begin{figure}[H]
  \centering
  % \includegraphics[width=0.8\textwidth]{Imagenes/crisp_dm.png} % Descomentar para usar la imagen real
  % --- Inicio: Placeholder de la figura ---
  \includegraphics[width=0.7\textwidth]{./Figures/crispdm.pdf}
  % --- Fin: Placeholder de la figura ---
  \caption{Diagrama de flujo de la metodología CRISP-DM adaptada para el trabajo.}
  \label{fig:crisp_dm_flujo}
\end{figure}

%----------------------------------------------------------------------------------------
%	ARQUITECTURA (Versión "Mapa General" para evitar redundancia)
%----------------------------------------------------------------------------------------
\section{Arquitectura del \textit{pipeline}}
\label{sec:arquitectura}

En esta sección se detalla el diseño arquitectónico del sistema desarrollado.
La solución fue estructurada como un flujo de trabajo lineal con
retroalimentación de control cerrado, concebido para transformar flujos de
datos estocásticos y asíncronos provenientes de video y sensores en
recomendaciones biomecánicas accionables y deterministas.

La arquitectura modular permitió el desacoplamiento estricto de las capas de
percepción, modelado físico y razonamiento algorítmico, lo que facilitó la
actualización independiente de los modelos de redes neuronales o los parámetros
del algoritmo genético sin que se comprometiera la integridad operativa del sistema
global.

El flujo lógico de datos, conceptualizado en el diagrama de bloques de la
Figura \ref{fig:arquitectura_sistema}, se organiza en cinco etapas secuenciales
críticas que abordan desde la física de la adquisición de la señal hasta la
convergencia matemática de la solución óptima:

\begin{figure}[H]
  \centering
  \includegraphics[width=0.9\textwidth]{Figures/Arquitectura_Pipeline.pdf}
  \caption{Diagrama en bloques detallado de la arquitectura del \textit{pipeline} y el flujo de datos multimodal.}
  \label{fig:arquitectura_sistema}
\end{figure}

\begin{enumerate}
  \item Entrada de datos (capa de adquisición): módulo de abstracción de hardware
        encargado de la captura sincronizada de fuentes heterogéneas, el cual gestionó
        \textit{buffers} circulares para video de alta velocidad y telemetría mediante 
        protocolos inalámbricos ANT+ \citep{ANTPlus} y BLE (Bluetooth Low Energy) \citep{Gomez2012BLE}.
  \item Procesamiento y análisis (capa de percepción): etapa de acondicionamiento de
        señal donde se ejecutó la inferencia de la red neuronal de detección de pose,
        se realizó la alineación temporal mediante correlación cruzada de señales y se
        aplicó filtrado digital selectivo para la reconstrucción cinemática.
  \item Modelado y simulación (capa física): instanciación del gemelo digital del
        ciclista, resolución del problema de dinámica inversa plana y estimación del
        ($C_d A$).
  \item Optimización multi-objetivo (capa de razonamiento): núcleo algorítmico donde un
        algoritmo genético exploró estocásticamente el espacio de configuraciones
        geométricas para resolver el conflicto entre confort biomecánico, eficiencia de
        potencia y resistencia aerodinámica.
  \item Salida y retroalimentación (capa de interfaz): generación del frente de Pareto,
        visualización sobre el flujo de video original y cierre del ciclo de control
        tras la verificación del ajuste físico.
\end{enumerate}

Esta arquitectura fue diseñada para ejecutarse completamente en el borde, lo
que permitió minimizar la latencia de inferencia y garantizar la privacidad de
los datos biomecánicos del ciclista al mantener todo el procesamiento local sin
necesidad de conexión a servicios externos. A continuación, se detalla la
implementación técnica específica de cada módulo.

%----------------------------------------------------------------------------------------
%	ADQUISICIÓN DE DATOS (Aquí movemos los detalles técnicos de HW y Sync)
%----------------------------------------------------------------------------------------
\section{Adquisición de datos}
\label{sec:adquisicion}

El módulo de adquisición de datos se diseñó para garantizar la integridad y la
coherencia temporal de la información de entrada, un requisito crítico para la
validez del análisis posterior. El sistema integró dos fuentes de información
principales: la captura óptica y la telemetría de sensores.

\subsection{Subsistema de video y restricciones ópticas}
La captura de video es el sustrato fundamental para la reconstrucción
cinemática 2D. Se utilizó una cámara de alta resolución ubicada en una posición
lateral estática, ortogonal al plano sagital del ciclista. Esta disposición
minimizó los errores de paralaje inherentes a la proyección 2D, una limitación
que se discute en el capítulo \ref{Chapter2}.

A diferencia de la grabación convencional, este módulo impuso restricciones
estrictas de hardware para garantizar la integridad de los mapas de calor
generados por la red neuronal en etapas posteriores:

\begin{itemize}
  \item Velocidad de obturación: se impuso un tiempo de exposición máximo de $t_{exp} \leq 1/500$ s. Esto fue crítico para eliminar el desenfoque de movimiento (\textit{motion blur}) en los marcadores anatómicos (especialmente el maléolo lateral \citep{Radiologia2013} y el quinto metatarso \citep{Wikipedia5Meta}), los cuales alcanzan velocidades angulares máximas $\omega_{max}$ en los puntos muertos del ciclo de pedaleo. El desenfoque en estas fases introduce un error sistemático no gaussiano en la inferencia de la posición articular.
  \item Tasa de fotogramas: se requirió una frecuencia de muestreo mínima de $f_s \geq 60$ FPS para cumplir con el teorema de Nyquist-Shannon \citep{Nyquist1928} aplicado a la cinemática del pedaleo, donde los armónicos de movimiento significativos se encuentran por debajo de 15 Hz.
  \item Normalización de entrada: la resolución de entrada se redimensionó dinámicamente para coincidir con el tensor de entrada de la CNN mediante interpolación bicúbica, lo que evitó artefactos de degradación de la señal (\textit{aliasing}).
\end{itemize}

\subsection{Entorno de análisis y telemetría}
Simultáneamente, se implementó la recolección de datos de rendimiento mediante
protocolos inalámbricos ANT+ \citep{ANTPlus} y BLE (Bluetooth Low Energy)
\citep{Gomez2012BLE}. El sistema se implementó sobre la plataforma
GoldenCheetah \citep{goldencheetah_web}, cuyo motor de ejecución de
Python integrado fue empleado como núcleo de procesamiento.

Esta arquitectura permitió la manipulación de datos de alto nivel y superó
las limitaciones del procesamiento de tramas crudas. En lugar de calcular la
potencia media $\bar{P}$ mediante diferencias de acumulados a nivel de byte, el
sistema utilizó las estructuras de datos internas de GoldenCheetah, lo que
garantizó la integridad y sincronización temporal de las muestras. La
implementación se basó en dos pilares documentados en la API:

\begin{itemize}
  \item Acceso a datos: recuperación de actividades y series temporales mediante funciones nativas, lo que aseguró la coherencia de los datos independientemente del protocolo de transmisión.
  \item Procesadores personalizados: implementación de algoritmos definidos por el usuario que operaron sobre la señal de potencia $P(t)$ ya depurada.
\end{itemize}

Las variables capturadas incluyeron: Potencia (W), Cadencia (RPM), Velocidad
virtual (km/h) y Frecuencia cardíaca (BPM) y derivadas.

\subsection{Sincronización temporal (Algoritmo de correlación)}
El desafío técnico principal en esta etapa fue la sincronización. Dado que el
video (muestreado a 60-240 Hz) y la telemetría (muestreada a 4 Hz) operan con
relojes independientes y latencias de transmisión variables, se implementó un
mecanismo de alineación temporal en el postprocesamiento.

El \textit{pipeline} implementó un algoritmo de alineación basado en la
cadencia para encontrar el desfase óptimo:

\begin{enumerate}
  \item Se extrajo una señal de cadencia visual ($\omega_{vis}$) mediante el análisis de la
        periodicidad de la coordenada vertical de la rodilla ($y_{knee}$) con la
        Transformada de Fourier de Tiempo Corto (STFT).
  \item Se obtuvo la señal de cadencia del sensor de potencia ($\omega_{sens}$).
  \item Se calculó la correlación cruzada normalizada $R_{vs}(\tau)$ para encontrar el
        desfase óptimo $\tau_{opt}$:
\end{enumerate}

\begin{equation}
  \tau_{opt} = \arg \max_{\tau} \int_{-\infty}^{\infty} \omega_{vis}(t) \cdot \omega_{sens}(t+\tau) \, dt
\end{equation}

Esto permitió alinear el pico de fuerza aplicado en el pedal con el ángulo de
la biela correspondiente con precisión de sub-fotograma, lo que superó la simple
alineación por inicio de movimiento.

%----------------------------------------------------------------------------------------
%	MODELADO (Aquí movemos la física: Ángulos, Aero y Dinámica Inversa)
%----------------------------------------------------------------------------------------
\section{Modelado cinemático y biomecánico}
\label{sec:modelado_cinematico}

Una vez que fueron extraídas las coordenadas $(x, y)$ de los puntos anatómicos
clave mediante la red neuronal, se procedió al modelado cinemático. El objetivo
de este módulo fue transformar datos posicionales abstractos en métricas
biomecánicas con significado clínico y deportivo, e integrar modelos físicos
avanzados.

\subsection{Análisis cinemático angular}
El modelo geométrico se construyó con base en la cinemática vectorial. Se
definieron vectores que representan los segmentos corporales del ciclista
(fémur, tibia, torso, húmero, radio). A partir de estos vectores, se calcularon
los ángulos articulares dinámicos en cada cuadro del video mediante el producto
escalar.

Los ángulos críticos modelados incluyeron:
\begin{itemize}
  \item Ángulo de extensión de rodilla (KFA): calculado en el punto muerto inferior (PMI). Es el predictor principal de la altura correcta del sillín.
  \item Ángulo de flexión de cadera: evaluado en el punto muerto superior (PMS). Determina la restricción aerodinámica y el riesgo de pinzamiento acetabular.
  \item Ángulo del hombro y codo: indicadores del alcance (\textit{reach}) y la caída (\textit{drop}) del manillar.
  \item Ángulo del tobillo: analizado para evaluar la técnica de pedaleo (\textit{ankling}).
\end{itemize}

Se aplicó un filtro de suavizado (filtro de Butterworth paso bajo) a las series
temporales de los ángulos para eliminar el ruido de alta frecuencia introducido
por la detección cuadro a cuadro (\textit{jitter}). La validación de estos
ángulos se realizó contra rangos de referencia bibliográficos, detallados en la
tabla \ref{tab:rangos_biomecanicos}.

\begin{table}[htbp]
  \caption{Parámetros biomecánicos y rangos óptimos definidos para el modelo.}
  \label{tab:rangos_biomecanicos}
  \centering
  \begin{tabular}{lcc}
    \toprule
    Parámetro Articular        & Rango Óptimo (Grados)          & Punto del Ciclo   \\ \midrule
    Extensión de Rodilla (KFA) & 135$^{\circ}$ -- 145$^{\circ}$ & PMI               \\
    Flexión de Cadera          & 50$^{\circ}$ -- 60$^{\circ}$   & PMS               \\
    Ángulo de Hombro           & 80$^{\circ}$ -- 90$^{\circ}$   & Estático/Dinámico \\
    Ángulo de Codo             & 150$^{\circ}$ -- 160$^{\circ}$ & Estático/Dinámico \\
    Extensión de Tobillo       & 90$^{\circ}$ -- 100$^{\circ}$  & Promedio          \\ \bottomrule
  \end{tabular}
\end{table}

\subsection{Estimación aerodinámica ($C_d A$)}
En esta etapa se predijo el comportamiento del sistema ciclista-bicicleta bajo
diferentes configuraciones geométricas sin necesidad de intervención física en
túnel de viento. El sistema estimó el Área Frontal Proyectada ($A_{proj}$)
utilizando una red de segmentación semántica sobre la vista lateral del
ciclista.

Aunque la vista lateral no captura directamente el área frontal, se aplicaron
modelos de regresión multivariable (basados en estudios de Bassett y Heil) los cuales
correlacionaron la pose sagital con el área frontal efectiva. El modelo
consideró la altura del torso y el ángulo de apertura de la cadera:

\begin{equation}
  A_{proj} \approx \alpha \cdot H_{torso} \cdot \sin(\theta_{cadera}) + \beta \cdot m_{ciclista}^{0.425} + \gamma
\end{equation}

Esto permitió cuantificar el coste aerodinámico ($P_{aero} \propto v^3 \cdot
  A_{proj}$) de cambios posturales, como bajar la altura del manillar ($Stack$).

\subsection{Dinámica inversa plana}
Al combinar la cinemática filtrada y los vectores de fuerza derivados de la
potencia (bajo el supuesto de una descomposición de fuerza tangencial efectiva), se
resolvieron las ecuaciones de Newton-Euler para calcular los momentos netos
articulares ($M_{net}$) en tobillo, rodilla y cadera. Esto permitió identificar
ineficiencias mecánicas, como momentos de flexión excesivos en la rodilla los cuales
no contribuyen a la propulsión.

%----------------------------------------------------------------------------------------
%	MODELADO DEL SISTEMA (Aquí va la AI: Pose + Optimización + Cost Functions)
%----------------------------------------------------------------------------------------
\section{Modelado del sistema de decisión}
\label{sec:modelado_sistema}

Esta sección describe el cerebro del sistema, compuesto por la integración
del modelo de detección de pose inteligente y el motor de optimización
matemática.

\subsection{Detección de pose y corrección cinemática}
Para la etapa de percepción, se implementó el modelo \textit{MediaPipe
  BlazePose}. Tal como se justificó en el marco teórico, este modelo ofrece una
topología de 33 puntos que incluye marcadores específicos para los pies. La red
neuronal procesó el flujo de video cuadro a cuadro, y se infirió la posición
espacial del esqueleto del ciclista, configurando parámetros de confianza de
detección y seguimiento superiores a 0.5.

Para adaptar la red de propósito general al contexto del ciclismo, se
implementó un filtro de Prior Cinemático. Dado que el ciclismo con calas
automáticas constituye una cadena cinética cerrada, la longitud de los
segmentos óseos debe permanecer invariante. El sistema penalizó y corrigió
detecciones que violaron la antropometría del sujeto:

\begin{equation}
  |L_{seg}(t) - \mu_{L_{seg}}| > \epsilon \Rightarrow \text{Corrección por cinemática inversa}
\end{equation}

Donde $L_{seg}(t)$ es la longitud euclidiana del segmento en el instante $t$ y
$\mu_{L_{seg}}$ es la longitud media calibrada.

\subsection{Motor de optimización multi-objetivo}
El núcleo de la propuesta es el algoritmo de optimización multi-objetivo. Dado
que la relación entre los ajustes de la bicicleta y la respuesta biomecánica es
no lineal y compleja, se diseñó un Algoritmo Genético (AG). Este enfoque
heurístico permite explorar eficientemente el espacio de soluciones sin
necesidad de conocer la derivada de la función objetivo.

El problema de optimización se formuló de la siguiente manera:
\begin{itemize}
  \item Genes: los parámetros ajustables de la bicicleta (altura del sillín, retroceso del sillín, longitud de la potencia, altura del manillar).
  \item Vector de estado: $\mathbf{x} = [h_{sillin}, x_{sillin}, h_{manillar}, x_{manillar}]$
\end{itemize}

\subsubsection{Funciones objetivo detalladas}
El sistema minimizó tres funciones de coste ($J$) que representan el conflicto
de objetivos:

\begin{enumerate}
  \item Minimizar disconfort ($J_{comfort}$): función de penalización cuadrática que se disparó cuando los ángulos articulares $\theta_j$ (extensión de rodilla, flexión de hombro, etc.) salieron de los rangos fisiológicos seguros predefinidos en la literatura médica:
        \begin{equation}
          J_{comfort}(\mathbf{x}) = \sum_{j=1}^{N} w_j \cdot \max(0, \theta_j(\mathbf{x}) - \theta_{max}, \theta_{min} - \theta_j(\mathbf{x}))^2
        \end{equation}
  \item Maximizar eficiencia biomecánica ($J_{power}$): se buscó minimizar la integral del momento articular absoluto necesario para producir una potencia objetivo, lo que implicó la búsqueda de una palanca más efectiva.
  \item Minimizar resistencia aerodinámica ($J_{aero}$): minimización directa del $C_d A$ estimado en la etapa de modelado físico (Sección 3.4.2).
\end{enumerate}

\subsubsection{Configuración y flujo del algoritmo}
El flujo del algoritmo comenzó con una población inicial de configuraciones
aleatorias (dentro de límites mecánicos viables). Mediante iteraciones
sucesivas de selección, cruce y mutación, el sistema convergió hacia una
configuración que satisfizo las restricciones biomecánicas.

Se empleó una población de $N=100$ individuos con codificación real. Se utilizó
selección por torneo binario, cruzamiento simulado con probabilidad $p_c = 0.9$
y mutación polinómica con probabilidad $p_m = 1/L$ (donde $L$ es el número de
variables). El mecanismo de elitismo aseguró la preservación de las mejores
soluciones del frente de Pareto a través de las generaciones.

En la tabla \ref{tab:parametros_optimizacion} se detallan los parámetros de
configuración utilizados.

\begin{table}[htbp]
  \caption{Parámetros de configuración del algoritmo de optimización.}
  \label{tab:parametros_optimizacion}
  \centering
  \begin{tabular}{lc}
    \toprule
    Parámetro del Algoritmo  & Valor / Configuración          \\ \midrule
    Tamaño de la población   & 100 individuos                 \\
    Número de generaciones   & 50                             \\
    Probabilidad de cruce    & 0.9                            \\
    Probabilidad de mutación & $1/L$ (Polinómica)             \\
    Método de selección      & Torneo Binario                 \\
    Restricciones anatómicas & Límites fisiológicos definidos \\ \bottomrule
  \end{tabular}
\end{table}

%----------------------------------------------------------------------------------------
%	REPORTE
%----------------------------------------------------------------------------------------
\section{Reporte de recomendaciones}
\label{sec:reporte}

La etapa final del diseño corresponde a la interfaz de salida. Se desarrolló un
módulo generador de reportes automatizados en formato PDF, diseñado para
traducir los resultados matemáticos de la optimización en instrucciones
comprensibles para el usuario final. El reporte sintetiza el análisis en tres
secciones:

\begin{enumerate}
  \item Diagnóstico actual: presentación visual de la postura inicial del ciclista con los ángulos medidos superpuestos sobre la imagen original, destacando en color rojo aquellos valores fuera del rango seguro.
  \item Plan de ejecución: una lista detallada de las modificaciones mecánicas sugeridas. Cada instrucción especifica el componente a ajustar, la dirección del ajuste y la magnitud en milímetros (por ejemplo, Subir sillín 5mm o Adelantar sillín 2mm).
  \item Predicción de resultados: una proyección de los nuevos ángulos biomecánicos esperados tras realizar los cambios sugeridos.
\end{enumerate}

Este documento sirve como guía para la modificación de la configuración
de la bicicleta. Tras la ejecución de los cambios, el sistema sugiere reiniciar
el proceso de adquisición de datos para validar las mejoras, lo que cierra el
ciclo de optimización continua.

% --- FIN DEL CAPÍTULO 3 ---